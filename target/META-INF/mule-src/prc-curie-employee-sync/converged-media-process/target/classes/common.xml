<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:anypoint-mq="http://www.mulesoft.org/schema/mule/anypoint-mq"
	xmlns:vm="http://www.mulesoft.org/schema/mule/vm" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/current/mule-vm.xsd
http://www.mulesoft.org/schema/mule/anypoint-mq http://www.mulesoft.org/schema/mule/anypoint-mq/current/mule-anypoint-mq.xsd">

	
	<sub-flow name="createProposalSubFlow" doc:id="7a844d8b-e78b-4a2d-be37-6570aeb726d6" >
		<logger level="INFO" doc:name="Before Request Logger" doc:id="3daa8637-c2ea-4581-891d-2f31510824d7" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	correlationId : correlationId,&#10;	requestId : vars.request.requestId,&#10;	message: "Calling Proposal api for create,update or openForEdit call"&#10;}]' />
		<http:request method="#[vars.method]" doc:name="Request Proposal" doc:id="60f67a71-26bd-4f1a-8505-681d0d87ccb0" config-ref="HTTP_Request_configuration_Proposals" target="proposalResponse" url="#[vars.path]">
			<http:body ><![CDATA[#[vars.proposalRequest]]]></http:body>
			<http:headers ><![CDATA[#[import * from dw::core::Binaries
output application/java
var auth = p("client_id") ++ ":" ++ p("client_secret")
---
{
	"Authorization" : "Basic " ++ toBase64(auth),
	"ext-gam-auth-header" : vars.token
}]]]></http:headers>
		</http:request>
		<logger level="INFO" doc:name="After Request Logger" doc:id="34a95ec1-2f62-4879-b035-f8430cf61f37" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	correlationId : correlationId,&#10;	requestId : vars.request.requestId,&#10;	message: "Proposal api call for create,update or openForEdit ended."&#10;}]' />
	</sub-flow>
	<sub-flow name="getProposalStatus_SubFlow" doc:id="b796c525-64b1-4fdb-b73d-ed7058d41439">
			<logger level="INFO" doc:name="Request START" doc:id="a4be0323-5020-48ac-9f20-0ff6af63d2ec" message='#[output application/json&#10;---&#10;{&#10; correlationId : correlationId,&#10; requestId : vars.request.requestId,&#10; message: "Calling /getProposalStatus on SAPI"&#10;}]' />
			<http:request method="POST" doc:name="Request Proposal" doc:id="25046227-11c3-4965-8923-38c35065d419" config-ref="HTTP_Request_configuration_Proposals" url="#[vars.path]">
				<http:headers><![CDATA[#[import * from dw::core::Binaries
output application/java
var auth = p("client_id") ++ ":" ++ p("client_secret")
---
{
	"Authorization" : "Basic " ++ toBase64(auth),
		'ext-gam-auth-header' : vars.gamToken
	}]]]></http:headers>
			</http:request>
			<logger level="INFO" doc:name="Request END" doc:id="0e0abce1-e14f-4a90-853e-910f95ed2afc" message='#[output application/json&#10;---&#10;{&#10; correlationId : correlationId,&#10; requestId : vars.request.requestId,&#10; message: "Received successful response from SAPI"&#10;}]' />
	</sub-flow>
	<sub-flow name="proposalLineItemSubFlow" doc:id="3520b8b4-95ac-48ab-b8e7-ed8714c30a9d" >
		<logger level="INFO" doc:name="Before Request Logger" doc:id="fdcb94da-6b5e-43d8-a835-cf6b5e5f2b25" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	correlationId : correlationId,&#10;	requestId : vars.request.requestId,&#10;	message: "Calling ProposalLineItem api for create,update,archive or openforedit call"&#10;}]' />
		<http:request method="#[vars.method]" doc:name="Request" doc:id="e34cbd99-c500-42c4-8956-32382c0b406c" config-ref="HTTP_Request_configuration_Proposals" target="proposalLineItemResponse" url="#[vars.path]">
			<http:body ><![CDATA[#[vars.proposalLineItemRequest]]]></http:body>
			<http:headers ><![CDATA[#[import * from dw::core::Binaries
output application/java
var auth = p("client_id") ++ ":" ++ p("client_secret")
---
{
	"Authorization" : "Basic " ++ toBase64(auth),
	"ext-gam-auth-header" : vars.token
}]]]></http:headers>
		</http:request>
		<logger level="INFO" doc:name="After Request Logger" doc:id="0a172b60-59a4-4658-ac72-8ae46c84b6ab" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	correlationId : correlationId,&#10;	requestId : vars.request.requestId,&#10;	message: "ProposalLineItem api call for create,update,archive or openforedit ended"&#10;}]' />
	</sub-flow>
	<sub-flow name="publish-queue-subflow" doc:id="c1a00b88-44af-449d-9e7b-2cda1dbc8fb6" >
		<set-variable value='#["${forwardResponse.flag}" default "false"]' doc:name="forwardResponseFlag" doc:id="4639f0ec-5ff0-4e48-a40a-d719b87f2919" variableName="forwardResponseflag"/>
		<choice doc:name="check forwardResponseFlag" doc:id="53a44890-61d6-44f4-83e7-1cfb434056c8" >
			<when expression='#[vars.forwardResponseFlag]' >
				<anypoint-mq:publish doc:name="Publish" doc:id="3cb0fc2e-34bd-4e83-ac7d-c661c5f7d617" config-ref="Anypoint_MQ_Config" destination="${forwardResponse.queue}" target="publishResponse"/>
				<logger level="INFO" doc:name="After publish" doc:id="6bb70efa-f159-472e-9a0b-01dd9833974e" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	correlationId : correlationId,&#10;	requestId : vars.request.requestId,&#10;	message: "The response payload has been published to the queue"&#10;}]' />
			</when>
			<otherwise >
				<logger level="INFO" doc:name="payload not published to queue" doc:id="c7dc83ca-100a-4941-bba6-03b6d61b1b8b" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	correlationId : correlationId,&#10;	requestId : vars.request.requestId,&#10;	message: "The response payload has not been published to the queue as forwardResponse is not true"&#10;}]' />
			</otherwise>
		</choice>
	</sub-flow>
</mule>
